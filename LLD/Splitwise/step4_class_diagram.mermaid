%% ========================================
%% STEP 4: ADD SERVICE LAYER
%% ========================================
%% WHAT WE ADDED: Service classes for business logic
%% WHY: Separate data (entities) from operations (services)
%% ========================================

classDiagram
    %% ========== ENTITIES (from Step 3) ==========
    class User {
        <<Entity>>
        -String userId
        -String name
        -String email
        -String phoneNumber
        -String passwordHash
        -Date createdAt
    }

    class Group {
        <<Entity>>
        -String groupId
        -String name
        -String description
        -String createdBy
        -Date createdAt
    }

    class Expense {
        <<Entity>>
        -String expenseId
        -String description
        -BigDecimal amount
        -String paidBy
        -String groupId
        -SplitType splitType
        -Map~String, BigDecimal~ splits
    }

    class Transaction {
        <<Entity>>
        -String transactionId
        -String payerId
        -String payeeId
        -BigDecimal amount
        -TransactionStatus status
    }

    %% ========== NEW: SERVICE LAYER ==========

    class UserService {
        <<Service>>
        -UserRepository userRepository
        -PasswordEncoder passwordEncoder
        +registerUser(UserDTO) User
        +login(email, password) String
        +updateProfile(userId, UserDTO) User
        +getUserById(userId) User
        +getUserBalance(userId) List~Balance~
        +getUsersByGroup(groupId) List~User~
    }

    class GroupService {
        <<Service>>
        -GroupRepository groupRepository
        -UserService userService
        +createGroup(name, description, creatorId) Group
        +addMember(groupId, userId) void
        +removeMember(groupId, userId) void
        +getGroupById(groupId) Group
        +getGroupMembers(groupId) List~User~
        +getGroupsByUser(userId) List~Group~
        +deleteGroup(groupId, userId) void
    }

    class ExpenseService {
        <<Service>>
        -ExpenseRepository expenseRepository
        -GroupService groupService
        -UserService userService
        -SplitCalculator splitCalculator
        +addExpense(ExpenseDTO) Expense
        +updateExpense(expenseId, ExpenseDTO) Expense
        +deleteExpense(expenseId, userId) void
        +getExpenseById(expenseId) Expense
        +getExpensesByGroup(groupId) List~Expense~
        +getExpensesByUser(userId) List~Expense~
        +calculateSplits(expense) Map~String, BigDecimal~
    }

    class TransactionService {
        <<Service>>
        -TransactionRepository transactionRepository
        -UserService userService
        -BalanceService balanceService
        +recordPayment(payerId, payeeId, amount, groupId) Transaction
        +cancelTransaction(transactionId) void
        +getTransactionById(transactionId) Transaction
        +getTransactionsByUser(userId) List~Transaction~
        +getTransactionsByGroup(groupId) List~Transaction~
    }

    class BalanceService {
        <<Service>>
        -ExpenseService expenseService
        -TransactionService transactionService
        +calculateUserBalance(userId) List~Balance~
        +calculateGroupBalance(groupId) List~Balance~
        +getBalanceBetweenUsers(userId1, userId2) BigDecimal
        +simplifyDebts(groupId) List~Transaction~
    }

    %% ========== HELPER CLASSES ==========

    class SplitCalculator {
        <<Helper>>
        +calculateEqualSplit(amount, participants) Map
        +calculateExactSplit(amount, splits) Map
        +calculatePercentageSplit(amount, percentages) Map
        +validateSplits(amount, splits) boolean
    }

    class PasswordEncoder {
        <<Utility>>
        +encode(password) String
        +matches(rawPassword, encodedPassword) boolean
    }

    %% ========== RELATIONSHIPS: Services to Entities ==========
    UserService ..> User : manages
    GroupService ..> Group : manages
    ExpenseService ..> Expense : manages
    TransactionService ..> Transaction : manages

    %% ========== RELATIONSHIPS: Services to Services ==========
    GroupService --> UserService : uses
    ExpenseService --> GroupService : uses
    ExpenseService --> UserService : uses
    ExpenseService --> SplitCalculator : uses
    TransactionService --> UserService : uses
    TransactionService --> BalanceService : uses
    BalanceService --> ExpenseService : uses
    BalanceService --> TransactionService : uses

    %% ========== RELATIONSHIPS: Services to Helpers ==========
    UserService --> PasswordEncoder : uses

    %% ========== NOTES ==========
    note for UserService "ğŸ‘¤ USER SERVICE\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nBusiness logic for user operations:\nâœ… Register new user\nâœ… Authenticate (login)\nâœ… Update profile\nâœ… Get user details\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nâš ï¸ Uses UserRepository (Step 5)\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nğŸ¯ Single Responsibility:\nOnly manages users"

    note for GroupService "ğŸ‘¥ GROUP SERVICE\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nOrchestrates group operations:\nâœ… Create/delete groups\nâœ… Add/remove members\nâœ… Validation: Is user admin?\nâœ… Check: Balance = 0 before leaving\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nâš ï¸ Depends on UserService\nto validate members exist"

    note for ExpenseService "ğŸ’° EXPENSE SERVICE\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nCore business logic:\nâœ… Add/edit/delete expenses\nâœ… Validate participants\nâœ… Calculate splits\nâœ… Update balances\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nâš ï¸ Orchestrates multiple services\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nğŸ”¥ Most complex service!"

    note for TransactionService "ğŸ’¸ TRANSACTION SERVICE\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nManages settlements:\nâœ… Record payments\nâœ… Update balances\nâœ… Validate payment amounts\nâœ… Notify users\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nâš ï¸ Works with BalanceService\nto update balances"

    note for BalanceService "ğŸ’° BALANCE SERVICE\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nCalculates balances:\nâœ… User's total balance\nâœ… Group balances\nâœ… Pairwise balances\nâœ… Simplify debts algorithm\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nâš ï¸ Read-only (no DB updates)\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nğŸ§® Pure calculation service"

    note for SplitCalculator "ğŸ§® SPLIT CALCULATOR\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nStrategy pattern (Step 6):\nâ€¢ EQUAL: amount Ã· n\nâ€¢ EXACT: use given amounts\nâ€¢ PERCENTAGE: amount Ã— %\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nâœ… Pure function (no side effects)\nâœ… Easy to test\nâœ… Reusable"

%% ========================================
%% KEY CONCEPTS:
%% 1. Services contain business logic
%% 2. Entities are just data holders
%% 3. Services orchestrate multiple entities
%% 4. Dependency Injection for services
%% ========================================
